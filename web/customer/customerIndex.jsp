<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ include file="/common/header.jsp" %>
<%@ include file="/common/menu.jsp" %>
<html>
<head>
    <meta charset="utf-8">
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="msapplication-tap-highlight" content="no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/font-awesome/4.6.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/customerService/service.css" />
    <link rel="stylesheet" href="../css/customerService/index.css" />
    <link rel="stylesheet" href="../css/assets/layui/css/layui.css" />
    <script type="text/javascript" src="../js/commonality/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="../js/commonality/layui/layui.js"></script>
</head>
<body>
<div class="layui-layout layui-layout-admin">
    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div class="main">
            <!-- 微信内容区域 -->
            <div class="main_inner">
                <div class="panel give_me">
                    <!-- 搜索框 -->
                    <div class="search_bar">
                        <img src="../image/dd.jpg"/>
                        <input  class="frm_search ng-isolate-scope ng-pristine ng-valid" type="text"  placeholder="搜索好友昵称">
                    </div>
                    <!-- 好友列表 -->
                    <div class="s-side">
                        <ul>
                            <!--这部分是导航栏信息。-->
                            <li class="first">
                                <div class="d-firstNav s-firstNav clearfix">
                                    <span>全部用户</span>
                                    <i class="fa fa-caret-right fr "></i>
                                </div>
                                <ul class="d-firstDrop s-firstDrop" style="background: #ebecf0;">



                                </ul>
                            </li>
                        </ul>
                    </div>

                </div>

                <!-- 素材 -->
                <div class="matter-div">
                    <div class="matter-case"> 素材</div>
                    <div class="matter-cases"> 素材-分类1</div>
                    <div class="allGoods_list">
                        <ul>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                        </ul>
                        <ul>
                            <li class="products">
                                <p class="allGoods_imgs">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="products">
                                <p class="allGoods_imgs">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="products">
                                <p class="allGoods_imgs">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                        </ul>
                    </div>
                    <div class="matter-cases"> 素材-分类2</div>
                    <div class="allGoods_list">
                        <ul>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                        </ul>
                        <ul>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>

                        </ul>
                        <ul>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                            <li class="product">
                                <p class="allGoods_img">
                                    <img src="http://omsproductionimg.yangkeduo.com/images/2017-10-19/59c9253f0047288d8744412eadf93f6c.jpeg">
                                </p>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 聊天区 -->
                <div style="height:100%;" class="ng-scope">
                    <div id="chatArea"  class="box chat ng-scope chatRoom">
                        <div class="scroll-wrapper box_bd chat_bd scrollbar-dynamic" style="position: absolute;">
                            <div class="box_bd chat_bd scrollbar-dynamic scroll-content scroll-scrolly_visible" id="cont" style="margin-bottom: 0px; margin-right: 0px; height: 600px;">
                                <div class="ng-scope">
                                    <div  class="top-placeholder ng-scope" style="height: 100%;"></div>
                                    <div  class="ng-scope">
                                        <div class="clearfix">
                                            <div class="onself" style="overflow: hidden;">
                                                <!-- 系统消息 -->
                                                <!-- 别人的信息 -->
                                            </div>

                                        </div>

                                    </div>
                                </div>
                            </div>
                                    <!-- 发送消息的地方 -->
                                    <div class="box_ft ng-scope" >
                                        <div class="toolbar" id="tool_bar">
                                            <a class="web_wechat_face"  href="javascript:;" title="表情">
                                                <img src="../image/face.png" />
                                            </a>
                                            <a class="web_wechat_screencut"  href="javascript:;" title="截屏">
                                                <img src="../image/screenshot.png" />
                                            </a>
                                            <a  class="web_wechat_pic js_fileupload ng-isolate-scope webuploader-container" id="test1" href="javascript:;" title="图片和文件">
                                                <img src="../image/file.png" />
                                                <input id="headId2" name="headPhone" type="file"  onchange="headImg()"/>

                                            </a>
                                        </div>
                                        <div class="content ng-isolate-scope" id="ng-scope"  track-opt="{target:'发送框',keys:['enter','backspace','blankspace']}">
                                            <pre id="editArea"  class="flex edit_area ng-isolate-scope" contenteditable="true"  contenteditable-directive=""></pre>
                                            <%--<span class="caret_pos_helper" id="caretPosHelper"></span>--%>
                                        </div>
                                        <div class="action">
                                            <a  class="desc ng-scope" href="javascript:;">结束会话</a>
                                            <a class="btn btn_send" onclick="sendMessage()" href="javascript:;" >发送</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
</body>
<script>
    //JavaScript代码区域
    layui.use('element', function(){
        var element = layui.element;

    });
    layui.use('jquery', function(){
        var $ = layui.jquery;
        var submit = function(){
            return false;
        };
        $('#test').on('submit', function(){
            return false
        });
        $('#test').on('submit', function(){
            return true
        });
    });

   var img='';
   var res='';
    window.onload =function(){
        $.ajax({
            //几个参数需要注意一下
            type: "get",//方法类型
            dataType: "json",//预期服务器返回的数据类型
            url: "${ctx}/wxindex?method=getWXContact" ,//url
            async : false,
            //  data: {loginName:loginName,pwd:pwd},
            success:function(data){
                    res = data.result.memberListJson.MemberList;
                    var img = data.result.headImgUrl;
                    var getList="";
                    for(var i=0; i<res.length; i++){
                        var userName = res[i].UserName;
                         //console.log(userName.substr(0,3),'ll');
                        if("@@" == userName.substr(0,2)){
                            getList += '<li class="second">';
                            getList +='<div class="d-firstNav s-firstNav f-friends">';
                            getList += '<span class="list-names">'+res[i].NickName+'</span>';
                            getList += '<i class="fa fa-caret-right fr"></i>';
                            getList += '</div>';
                            getList += '<ul class="d-secondDrop s-secondDrop">';
                            getList += '<li class="s-thirdItem">';
                            getList += '<div class="layui-form-item" >';
                            getList += '<div class="layui-input-block" style="margin-left: 30px;color:#333333;">';
                            getList += '<input type="checkbox" name="like1[write]" lay-skin="primary" title="写作" > 易烊千玺';
                            getList += '</div>';
                            getList += '</div>';
                            getList += '</li>';
                            getList += '</ul>';
                            getList += ' </li>';
                        }else {
                            getList += '<li class="s-thirdItem"style="background-color: #FFFFFF;">';
                            getList += '<div class="layui-form-item" style="margin-bottom: 0px;" >';
                            getList += '<div class="layui-input-block" style="margin-left: 15px;color:#333333;height: 46px;line-height: 46px;">';
                            getList += '<input  type="radio" id="radioId" value= "'+res[i].UserName+'" name="radioName" lay-skin="primary" title="" onclick="getUserName()">';
                            getList += res[i].NickName;
                            getList += '</div>';
                            getList += '</div>';
                            getList += '</li>';

                        }


                    }
                    $('.s-firstDrop').html(getList);
                setInterval(alertFunc, 2000);
            },
            error:function(){
                alert("系统繁忙，请重试");
            },
        });
    }
// 发送消息
    var toUserName='';
    function getUserName() {
        toUserName = $("input[name='radioName']:checked").val();
    }
    function sendMessage() {
        var cont = document.getElementById('cont');
        var message = document.getElementById('editArea').innerHTML;
        var ToUserName = toUserName;
        var meImag = img;
        var getHtml ="";
        getHtml+='<div  class="message ng-scope me first">';
        getHtml+='<div  class="message_system ng-scope">';
        getHtml+='<div  class="content ng-binding ng-scope">18:02</div>';
        getHtml+='</div>';
        getHtml+='<img class="avatar" src='+meImag+' >';
        getHtml+='<div class="content"> ';
        getHtml+='<div class="bubble js_message_bubble ng-scope bubble_primary right">';
        getHtml+='<div class="bubble_cont ng-scope">';
        getHtml+='<div class="plain">';
        getHtml+='<pre class="js_message_plain ng-binding">'+message+'</pre>';
        getHtml+='</div>';
        getHtml+='</div>';
        getHtml+='</div>';
        getHtml+='</div>';
        getHtml+='</div>';
        $('.onself').append(getHtml)

        $.ajax({
            url: "${ctx}/wxindex?method=sendMessage",
            type: "get",
            dataType: "json",
            data: {
                "message":message,
                "ToUserName":ToUserName
            },
            success: function (data) {
                 var message = $("#editArea").remove().innerHTML;
                 var getphtml="";
                 getphtml+='<pre id="editArea"  class="flex edit_area ng-isolate-scope" contenteditable="true"  contenteditable-directive=""></pre>';
                 $('#ng-scope').html(getphtml);
            },
            error: function (data) {
                alert(data.result);
            }
        });
        cont.scrollTop = cont.scrollHeight;
    }
    // 查询消息
    function alertFunc() {
        var receiveRes =res;
        for (var i=0;i<receiveRes.length;i++){
            // 别人的头像
            var receiveImage = receiveRes[i].HeadImgUrl;
        }
        $.ajax({
            url: "${ctx}/wxindex?method=getWXMessage",
            type: "get",
            async : false,
            dataType: "json",
            data: {
            },
            // processData: false,
            success: function (data) {
                // 收到别人的信息
                var receiveInformation = data.result;
                if(receiveInformation != undefined && receiveInformation != ''){
                    var getReceive ='';
                    getReceive+='<div ng-switch-default="" class="message ng-scope you" >';
                    getReceive+='<img class="avatar" src='+receiveImage+' >';
                    getReceive+='<div class="content">';
                    getReceive+='<div class="bubble js_message_bubble ng-scope bubble_default left">';
                    getReceive+='<div class="bubble_cont ng-scope">';
                    getReceive+='<div class="plain">';
                    getReceive+='<pre class="js_message_plain ng-binding">'+receiveInformation+'</pre>';
                    getReceive+='</div>';
                    getReceive+='</div>';
                    getReceive+='</div>  ';
                    getReceive+='</div>';
                    getReceive+='</div>';
                    $('.onself').append(getReceive);

                }

            },
            error: function (data) {
            }
        });
    }

    //发送图片
    function headImg() {
        var v =  $('#headId2').val();
        var resImage =toUserName;
        var formData = new FormData();
        var img_file = document.getElementById("headId");
        if (undefined == img_file) {
            img_file = document.getElementById("headId2");
        }
        var fileObject = img_file.files[0];
        formData.append("headPhone", fileObject);
        formData.append("ToUserName",resImage);
        $.ajax({
            url: "${ctx}/wxindex?method=sendImageMessage",
            type: "POST",
            dataType: "json",
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
               console.log("sendImg",data.result)
            },
            error: function (data) {
                console.log("sendImg",data.result)
            }
        });
    }
</script>
<script type="text/javascript" src="../js/customerService/index.js"></script>
<script type="text/javascript" src="../js/customerService/service.js"></script>
</html>